Ember.TEMPLATES["javascripts/connectors/composer-fields/presence"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[28,"composer-presence-display",null,[["model"],[[24,["model"]]]]],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/connectors/composer-fields/presence"}}),define("discourse/plugins/discourse-presence/discourse/templates/connectors/composer-fields/presence",["exports"],(function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;e.default={shouldRender:function(e,s){return s.siteSettings.presence_enabled}}})),Ember.TEMPLATES["javascripts/connectors/topic-above-footer-buttons/presence"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[28,"topic-presence-display",null,[["topic"],[[24,["model"]]]]],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/connectors/topic-above-footer-buttons/presence"}}),define("discourse/plugins/discourse-presence/discourse/templates/connectors/topic-above-footer-buttons/presence",["exports"],(function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;e.default={shouldRender:function(e,s){return s.siteSettings.presence_enabled}}})),Ember.TEMPLATES["javascripts/components/topic-presence-display"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["user"],"statements":[[4,"if",[[24,["shouldDisplay"]]],null,{"statements":[[0,"  "],[7,"div",true],[10,"class","presence-users"],[8],[0,"\\n    "],[7,"div",true],[10,"class","presence-avatars"],[8],[0,"\\n"],[4,"each",[[24,["users"]]],null,{"statements":[[0,"        "],[1,[28,"avatar",[[23,1,[]]],[["avatarTemplatePath","usernamePath","imageSize"],["avatar_template","username","small"]]],false],[0,"\\n"]],"parameters":[1]},null],[0,"    "],[9],[0,"\\n    "],[7,"span",true],[10,"class","presence-text"],[8],[0,"\\n      "],[7,"span",true],[10,"class","description"],[8],[1,[28,"i18n",["presence.replying_to_topic"],[["count"],[[24,["users","length"]]]]],false],[9],[7,"span",true],[10,"class","wave"],[8],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[9],[0,"\\n    "],[9],[0,"\\n  "],[9],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/topic-presence-display"}}),Ember.TEMPLATES["javascripts/components/composer-presence-display"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["user"],"statements":[[4,"if",[[24,["shouldDisplay"]]],null,{"statements":[[0,"  "],[7,"div",true],[10,"class","presence-users"],[8],[0,"\\n    "],[7,"div",true],[10,"class","presence-avatars"],[8],[0,"\\n"],[4,"each",[[24,["presenceUsers"]]],null,{"statements":[[0,"        "],[1,[28,"avatar",[[23,1,[]]],[["avatarTemplatePath","usernamePath","imageSize"],["avatar_template","username","small"]]],false],[0,"\\n"]],"parameters":[1]},null],[0,"    "],[9],[0,"\\n    "],[7,"span",true],[10,"class","presence-text"],[8],[0,"\\n      "],[7,"span",true],[10,"class","description"],[8],[0,"\\n"],[4,"if",[[24,["isReply"]]],null,{"statements":[[1,[28,"i18n",["presence.replying"],[["count"],[[24,["presenceUsers","length"]]]]],false]],"parameters":[]},{"statements":[[1,[28,"i18n",["presence.editing"],[["count"],[[24,["presenceUsers","length"]]]]],false]],"parameters":[]}],[0,"      "],[9],[9],[7,"span",true],[10,"class","wave"],[8],[0,"\\n      "],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[7,"span",true],[10,"class","dot"],[8],[0,"."],[9],[0,"\\n    "],[9],[0,"\\n  "],[9],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/templates/components/composer-presence-display"}}),define("discourse/plugins/discourse-presence/discourse/lib/presence",["exports","@ember/runloop","@ember/object","discourse/lib/ajax","discourse-common/utils/decorators"],(function(e,s,t,r,i){"use strict";var n,c;Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.COMPOSER_TYPE=e.TOPIC_TYPE=e.CLOSED=e.EDITING=e.REPLYING=e.KEEP_ALIVE_DURATION_SECONDS=void 0;e.KEEP_ALIVE_DURATION_SECONDS=10;var o="replying";e.REPLYING=o;var a="editing";e.EDITING=a;var l="closed";e.CLOSED=l;e.TOPIC_TYPE="topic";e.COMPOSER_TYPE="composer";var u,p,d,h,b,m,f=t.default.extend((n=(0,i.default)("topicId"),u=c={users:null,editingUsers:null,subscribers:null,topicId:null,currentUser:null,messageBus:null,siteSettings:null,init:function(){this._super.apply(this,arguments),this.setProperties({users:[],editingUsers:[],subscribers:new Set})},subscribe:function(e){var s=this;0===this.subscribers.size&&this.messageBus.subscribe(this.channel,(function(e){var t=e.user,r=e.state;if(s.get("currentUser.id")!==t.id)switch(r){case o:s._appendUser(s.users,t);break;case a:s._appendUser(s.editingUsers,t,{post_id:parseInt(e.post_id,10)});break;case l:s._removeUser(t)}}),0),this.subscribers.add(e)},unsubscribe:function(e){this.subscribers.delete(e);var s=0===this.subscribers.size;return s&&(this.messageBus.unsubscribe(this.channel),this._stopTimer(),this.setProperties({users:[],editingUsers:[]})),s},channel:function(e){return"/presence/".concat(e)},publish:function(e,s,t,i){var n=this.get("currentUser.user_option.hide_profile_and_presence");if(void 0===n&&(n=this.get("currentUser.hide_profile_and_presence")),!n||!this.get("siteSettings.allow_users_to_hide_profile")){var c={state:e,topic_id:this.topicId};return s&&(c.is_whisper=!0),t&&e===a&&(c.post_id=t),i&&(c.staff_only=!0),(0,r.ajax)("/presence/publish",{type:"POST",data:c})}},_removeUser:function(e){[this.users,this.editingUsers].forEach((function(s){var t=s.findBy("id",e.id);t&&s.removeObject(t)}))},_cleanUpUsers:function(){return[this.users,this.editingUsers].forEach((function(e){var s=[];e.forEach((function(e){e.last_seen<=Date.now()-12e3&&s.push(e)})),e.removeObjects(s)})),0===this.users.length&&0===this.editingUsers.length},_appendUser:function(e,s,r){var i,n=this,c=0;e.forEach((function(e){e.id===s.id&&(i=e),r&&r.post_id?e.post_id===r.post_id&&c++:c++}));var o=r||{};if(o.last_seen=Date.now(),i)i.setProperties(o);else{var a=this.get("siteSettings.presence_max_users_shown");c<a&&e.pushObject(t.default.create(Object.assign(s,o)))}this._startTimer((function(){n._cleanUpUsers()}))},_scheduleTimer:function(e){var t=this;return(0,s.later)(this,(function(){e()||t.set("_timer",t._scheduleTimer(e))}),2e3)},_stopTimer:function(){(0,s.cancel)(this._timer)},_startTimer:function(e){this._timer||this.set("_timer",this._scheduleTimer(e))}},p="channel",d=[n],h=Object.getOwnPropertyDescriptor(c,"channel"),b=c,m={},Object.keys(h).forEach((function(e){m[e]=h[e]})),m.enumerable=!!m.enumerable,m.configurable=!!m.configurable,("value"in m||m.initializer)&&(m.writable=!0),m=d.slice().reverse().reduce((function(e,s){return s(u,p,e)||e}),m),b&&void 0!==m.initializer&&(m.value=m.initializer?m.initializer.call(b):void 0,m.initializer=void 0),void 0===m.initializer&&(Object.defineProperty(u,p,m),m=null),c));e.default=f})),define("discourse/plugins/discourse-presence/discourse/components/composer-presence-display",["exports","discourse/plugins/discourse-presence/discourse/lib/presence","@ember/runloop","discourse-common/utils/decorators","@ember/object/computed","@ember/component","@ember/service"],(function(e,s,t,r,i,n,c){"use strict";var o,a,l,u,p,d,h,b,m;function f(e,s,t,r,i){var n={};return Object.keys(r).forEach((function(e){n[e]=r[e]})),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=t.slice().reverse().reduce((function(t,r){return r(e,s,t)||t}),n),i&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(i):void 0,n.initializer=void 0),void 0===n.initializer&&(Object.defineProperty(e,s,n),n=null),n}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var g=n.default.extend((o=(0,r.default)("model.topic.id"),a=(0,r.default)("model.topic.id"),l=(0,r.on)("didInsertElement"),u=(0,r.default)("model.post.id","editingUsers.@each.last_seen","users.@each.last_seen","isReply","isEdit"),p=(0,r.observes)("model.reply","model.title"),d=(0,r.observes)("model.whisper"),h=(0,r.observes)("model.action","model.topic.id"),b=(0,r.on)("willDestroyElement"),f(m={presenceManager:(0,c.inject)(),users:function(e){return this.presenceManager.users(e)},editingUsers:function(e){return this.presenceManager.editingUsers(e)},isReply:(0,i.readOnly)("model.replyingToTopic"),isEdit:(0,i.readOnly)("model.editingPost"),subscribe:function(){this.presenceManager.subscribe(this.get("model.topic.id"),s.COMPOSER_TYPE)},presenceUsers:function(e,s,t,r,i){return i?s.filterBy("post_id",e):r?t:[]},shouldDisplay:(0,i.gt)("presenceUsers.length",0),typing:function(){(0,t.throttle)(this,this._typing,1e3*s.KEEP_ALIVE_DURATION_SECONDS)},_typing:function(){if((this.isReply||this.isEdit)&&this.get("model.composerOpened")){var e={topicId:this.get("model.topic.id"),state:this.isEdit?s.EDITING:s.REPLYING,whisper:this.get("model.whisper"),postId:this.get("model.post.id"),presenceStaffOnly:this.get("model._presenceStaffOnly")};this._prevPublishData=e,this._throttle=this.presenceManager.publish(e.topicId,e.state,e.whisper,e.postId,e.presenceStaffOnly)}},cancelThrottle:function(){this._cancelThrottle()},composerState:function(){this._prevPublishData&&(this.presenceManager.publish(this._prevPublishData.topicId,s.CLOSED,this._prevPublishData.whisper,this._prevPublishData.postId),this._prevPublishData=null)},closeComposer:function(){this._cancelThrottle(),this._prevPublishData=null,this.presenceManager.cleanUpPresence(s.COMPOSER_TYPE)},_cancelThrottle:function(){this._throttle&&((0,t.cancel)(this._throttle),this._throttle=null)}},"users",[o],Object.getOwnPropertyDescriptor(m,"users"),m),f(m,"editingUsers",[a],Object.getOwnPropertyDescriptor(m,"editingUsers"),m),f(m,"subscribe",[l],Object.getOwnPropertyDescriptor(m,"subscribe"),m),f(m,"presenceUsers",[u],Object.getOwnPropertyDescriptor(m,"presenceUsers"),m),f(m,"typing",[p],Object.getOwnPropertyDescriptor(m,"typing"),m),f(m,"cancelThrottle",[d],Object.getOwnPropertyDescriptor(m,"cancelThrottle"),m),f(m,"composerState",[h],Object.getOwnPropertyDescriptor(m,"composerState"),m),f(m,"closeComposer",[b],Object.getOwnPropertyDescriptor(m,"closeComposer"),m),m));e.default=g})),define("discourse/plugins/discourse-presence/discourse/components/topic-presence-display",["exports","discourse-common/utils/decorators","@ember/component","discourse/plugins/discourse-presence/discourse/lib/presence","@ember/object/computed","@ember/service"],(function(e,s,t,r,i,n){"use strict";var c,o,a,l;function u(e,s,t,r,i){var n={};return Object.keys(r).forEach((function(e){n[e]=r[e]})),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=t.slice().reverse().reduce((function(t,r){return r(e,s,t)||t}),n),i&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(i):void 0,n.initializer=void 0),void 0===n.initializer&&(Object.defineProperty(e,s,n),n=null),n}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var p=t.default.extend((c=(0,s.default)("topic.id"),o=(0,s.on)("didInsertElement"),a=(0,s.on)("willDestroyElement"),u(l={topic:null,topicId:null,presenceManager:(0,n.inject)(),users:function(e){return this.presenceManager.users(e)},shouldDisplay:(0,i.gt)("users.length",0),didReceiveAttrs:function(){this._super.apply(this,arguments),this.topicId&&this.presenceManager.unsubscribe(this.topicId,r.TOPIC_TYPE),this.set("topicId",this.get("topic.id"))},subscribe:function(){this.set("topicId",this.get("topic.id")),this.presenceManager.subscribe(this.get("topic.id"),r.TOPIC_TYPE)},_destroyed:function(){this.presenceManager.unsubscribe(this.get("topic.id"),r.TOPIC_TYPE)}},"users",[c],Object.getOwnPropertyDescriptor(l,"users"),l),u(l,"subscribe",[o],Object.getOwnPropertyDescriptor(l,"subscribe"),l),u(l,"_destroyed",[a],Object.getOwnPropertyDescriptor(l,"_destroyed"),l),l));e.default=p})),define("discourse/plugins/discourse-presence/discourse/services/presence-manager",["exports","discourse/plugins/discourse-presence/discourse/lib/presence","@ember/service"],(function(e,s,t){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var r=t.default.extend({presences:null,init:function(){this._super.apply(this,arguments),this.setProperties({presences:{}})},subscribe:function(e,s){e&&this._getPresence(e).subscribe(s)},unsubscribe:function(e,s){e&&(this._getPresence(e).unsubscribe(s)&&delete this.presences[e])},users:function(e){return e?this._getPresence(e).users:[]},editingUsers:function(e){return e?this._getPresence(e).editingUsers:[]},publish:function(e,s,t,r,i){if(e)return this._getPresence(e).publish(s,t,r,i)},cleanUpPresence:function(e){var t=this;Object.keys(this.presences).forEach((function(r){t.publish(r,s.CLOSED),t.unsubscribe(r,e)}))},_getPresence:function(e){return this.presences[e]||(this.presences[e]=s.default.create({messageBus:this.messageBus,siteSettings:this.siteSettings,currentUser:this.currentUser,topicId:e})),this.presences[e]}});e.default=r}));
//# sourceMappingURL=/assets/plugins/discourse-presence-3a1680892decb2ae359c90056c3a28435bb692b45d90f1bc19251e2525e77280.js.map